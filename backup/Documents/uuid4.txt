CREATE COMPUTE MODULE UUID4

--
--  Generatie van een Version 4 UUID
--  ================================
--
--  Voorbeeld......: 1f6a4dd4-a8ec-4160-b870-f583338e3a04
--  XSD validatie..:
--  Info:..........: https://en.wikipedia.org/wiki/Universally_unique_identifier#Version_4_(random)
--
--  16 random bytes:
--     behalve de eerste 4 bits van de 7e byte, die moeten 0100 zijn  (version 4)
--     behalve de eerste 2 bits van de 9e byte, die moeten 10 zijn    (variant 2)
--
--  Oftewel:
--     48 random bits
--      4 vaste bits '0100'
--     12 random bits
--      2 vaste bits '10'
--     62 random bits
--
--  Weergegeven als een hex string met 4 streepjes, in onderstaande layout.
-- 
--     xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
--     123456789012345678901234567890123456
--
--
--  Voorbeeld output van deze flow
--  -------------------------------
--  <test>
--    <uuid iib="f250db2c-5681-11ea-9fba-7f0000010000" A="b266201a-9717-4f5a-a7b9-e95b5162f2f8" B="d4d6f415-2185-4fa6-8e0a-43c0aa748781" C="0a038f82-1407-44b1-bc67-5cc29ff0e75b"/>
--    <uuid iib="f2512168-5681-11ea-9fba-7f0000010000" A="b01b6b6d-6fcf-4475-9e75-07dd9d1de5c8" B="16c612f4-d033-4965-b1d0-31e247f463c4" C="4c6fe552-98df-4279-82fb-fa1cb88596b7"/>
--    <uuid iib="f2515886-5681-11ea-9fba-7f0000010000" A="1db540b2-703e-4e08-b15a-7128eb52072b" B="924fd8a9-fd92-4763-bbc2-48e2183a91c4" C="7d36e102-fa6d-4ac6-9d73-6b0bfb50cd35"/>
--    <uuid iib="f2518efa-5681-11ea-9fba-7f0000010000" A="baeaa66c-c03e-43cd-b1ff-82b21216abda" B="782df202-8257-48b9-87d0-305afd7260b5" C="f72f90db-ee5f-488d-bdaa-6b10ba3f0c5d"/>
--    <uuid iib="f251c79e-5681-11ea-9fba-7f0000010000" A="939cf6b0-6a98-45b9-ac02-8ecf65194a80" B="3da75a68-bc07-4a23-8130-b0b4fcef6169" C="1062539c-20c4-4b7c-aec8-16b3718547d0"/>
--    <uuid iib="f251fe9e-5681-11ea-9fba-7f0000010000" A="55fb093d-9567-426d-987c-2fc6b666722f" B="7fdf50e4-7afc-4e41-8d8e-8a0887011411" C="76093360-ec12-46de-98fb-3c3c0daaf8ae"/>
--    <uuid iib="f252358a-5681-11ea-9fba-7f0000010000" A="cc8f267a-d3cd-4039-99ff-c2e49c723e84" B="b19667a3-526c-4d51-a996-78e87b7ef1d0" C="3ad98bd6-75b3-4172-87e0-4ac113baf58e"/>
--    <uuid iib="f2526ba4-5681-11ea-9fba-7f0000010000" A="4ee527cc-7b89-4ac3-936a-1ffc4d7b08d1" B="db45300d-cd6b-40a8-8c06-ef8e523ddf1c" C="880986c3-1013-4f9b-ac08-c39803220544"/>
--    <uuid iib="f252a27c-5681-11ea-9fba-7f0000010000" A="b3a5fec2-4743-4718-9844-126ff72d0190" B="d3c5a877-c15f-4a70-8bec-b433b8ef6867" C="87bcc73f-0f79-4f99-b7cf-0023cfe9e981"/>
--    <uuid iib="f252d94a-5681-11ea-9fba-7f0000010000" A="720e392c-d7df-4ede-9fc6-056e101c90a6" B="7d5cfd64-d346-472b-988b-10809eba2101" C="030c1b62-0618-48b1-b628-6793d7008997"/>
--    <uuid iib="f253102c-5681-11ea-9fba-7f0000010000" A="0bce8b47-7a8d-416e-87bb-862039649f26" B="f9f431f7-d9fe-43ba-b951-62760f10c4ec" C="f0f97f71-e1f3-431a-b780-5bbc6d976560"/>
--    <uuid iib="f2534772-5681-11ea-9fba-7f0000010000" A="e64fd215-ede4-4fe8-a5d2-4f94cc23b502" B="3cd1ebb0-76ea-46bf-8d00-4c9c45649938" C="9a673f21-34ce-4500-a87a-296e82afc349"/>
--    <uuid iib="f2537ddc-5681-11ea-9fba-7f0000010000" A="28d165ac-2c01-455e-871e-d201a74e1999" B="c003017d-132e-469c-b7b9-7fc8a4deff91" C="c275fa5d-84eb-4896-9054-556beca74d8d"/>
--    <uuid iib="f253b3e2-5681-11ea-9fba-7f0000010000" A="540b9fd1-1cf3-4d0e-95c6-e5fa768f2131" B="69f656c4-817a-41f1-8747-214a70084294" C="16006136-2c00-4f8e-8f52-3a5d2976a77c"/>
--    <uuid iib="f253ea24-5681-11ea-9fba-7f0000010000" A="b36834d8-1377-432e-aadc-c0d28f4b04e3" B="fc48522b-1fb9-49d1-a1d6-5a8ba2cab517" C="e54d0519-ca9a-45f0-b9ee-de47fc46926f"/>
--    <uuid iib="f25420a2-5681-11ea-9fba-7f0000010000" A="967c8563-32f4-402d-b680-a73a9d2eb8db" B="2846e5dc-34e3-42ac-bdce-b94c5ad37298" C="85ba6355-0b74-460f-bb06-be0bbb5efde1"/>
--    <uuid iib="f2545702-5681-11ea-9fba-7f0000010000" A="8ef90d86-581c-4cc5-af45-811a5390c0f7" B="8ded759d-d861-47ce-877f-da6f7c79b4de" C="4f7d4dec-9efa-4a6b-91ad-6227a667322b"/>
--    <uuid iib="f2548d1c-5681-11ea-9fba-7f0000010000" A="356f2c91-1f93-4038-9d80-d8865f83427f" B="618b5be2-de83-462f-9707-ff1d8421fe3b" C="2e81662a-5d02-4f42-843e-03cd4295419a"/>
--    <uuid iib="f254c480-5681-11ea-9fba-7f0000010000" A="ea7edf2b-8290-4af6-a8af-b2e1f46f760b" B="489dbb00-b217-4310-8c7c-8fc760691f8e" C="27d0d3c0-4fa1-45b6-91f5-5107ace89041"/>
--    <uuid iib="f25500e4-5681-11ea-9fba-7f0000010000" A="8db3d2d5-cd0e-4b1e-88d8-ee43a7639c74" B="4cc6e124-52d6-4fe7-a022-2a0a43aa5414" C="1ee46e6a-3dc8-45dd-a11e-9dc2e093093d"/>
--    <uuid iib="f25537d0-5681-11ea-9fba-7f0000010000" A="38ceaaf3-8727-4b61-8c4c-9b0d00532bb0" B="ed4702f7-4a48-4cf3-b6d5-f813367bf026" C="72f5113a-e5ea-4d26-8c99-b524f5cc72a9"/>
--    <uuid iib="f2556f8e-5681-11ea-9fba-7f0000010000" A="4560b738-bf17-40f7-85b4-165fb2db9ae8" B="f9f7ea75-3f40-4f1a-80be-fcefb3bdf9df" C="69a8e8d2-d351-439e-a188-6f8e22d7456a"/>
--    <uuid iib="f255a684-5681-11ea-9fba-7f0000010000" A="3a94916e-caf3-4ffe-8d9b-8837c28b9b4b" B="f51f50d7-e4cc-44f2-8ec7-7c9a6c2af934" C="625b338e-c4b6-49b8-9a8d-27d1298f306c"/>
--    <uuid iib="f255ddc0-5681-11ea-9fba-7f0000010000" A="46536454-e0c6-4443-9ce0-83c711b975f9" B="933e2e39-68e1-4fe4-b3d6-d0e6993da1cd" C="4bcb7cbc-9796-4275-846f-ceae387524c6"/>
--    <uuid iib="f2561434-5681-11ea-9fba-7f0000010000" A="3da71dee-cf6f-4be1-b9a3-ead71d4e27f6" B="a6c36d27-cb57-4077-8708-e998c261d331" C="df7321b5-bee6-4041-b41d-c80ca67c42a9"/>
--  </test>
--

  CREATE FUNCTION Main() RETURNS BOOLEAN

  BEGIN

    DECLARE I INT 1;

    WHILE I <= 25 DO

      SET OutputRoot.XMLNSC.test.uuid[I].(XMLNSC.Attribute)iib = UUIDASCHAR;
      SET OutputRoot.XMLNSC.test.uuid[I].(XMLNSC.Attribute)A   = UUID4ASCHAR_A ();
      SET OutputRoot.XMLNSC.test.uuid[I].(XMLNSC.Attribute)B   = UUID4ASCHAR_B ();
      SET OutputRoot.XMLNSC.test.uuid[I].(XMLNSC.Attribute)C   = UUID4ASCHAR_C ();

      SET I = I + 1;

    END WHILE;

    RETURN TRUE;

  END;

  CREATE FUNCTION UUID4ASCHAR_A () RETURNS CHAR

  BEGIN

    --
    --  UUID Version 4
    --  ---------------
    --
    --  SUBSTRING(CAST(CAST(CAST(RAND()*16 AS INT) AS BLOB) AS CHAR) FROM 18 FOR 1)
    -- 
    --  * RAND() geeft een FLOAT van 0 tot 1 (1 niet inclusief), bv, 0.234566543
    --  * Eerste CAST naar INTEGER maakt van deze float een integer, in de range van 0 tot 15
    --  * Tweede CAST naar BLOB maakt daar een 8 bytes binaire string van (8 omdat INTEGER in IIB 64 bits is)
    --  * Derde CAST naar CHARACTER maakt hier een 16 lang hex string van, bv X'0000000000000005'
    --  * De SUBSTRING haalt de 4 bits eruit van de 64 bits die we gebruiken als 1 hex positie
    --

    DECLARE I INT 1;
    DECLARE U CHAR '';

    WHILE I <= 36 DO

      IF     I IN (9,14,19,24) THEN SET U = U || '-';
      ELSEIF I = 15            THEN SET U = U || '4';
      ELSEIF I = 20            THEN SET U = U || SUBSTRING(CAST(CAST( 8 + CAST(RAND()*4  AS INT) AS BLOB) AS CHAR) FROM 18 FOR 1);
      ELSE                          SET U = U || SUBSTRING(CAST(CAST(     CAST(RAND()*16 AS INT) AS BLOB) AS CHAR) FROM 18 FOR 1);
      END IF;

      SET I = I + 1;

    END WHILE;

    RETURN U;

  END;

  CREATE FUNCTION UUID4ASCHAR_B () RETURNS CHAR

  BEGIN

    --
    --  UUID Version 4
    --  ---------------
    --
    --  * RAND() geeft een FLOAT van 0 tot 1 (1 niet inclusief), bv, 0.234566543
    --  * Eerste CAST naar INTEGER maakt van deze float een integer.
    --  * Tweede CAST naar BLOB maakt daar een 8 bytes binaire string van (8 omdat een INTEGER in IIB 64 bits is)
    --  * Derde CAST naar CHARACTER maakt hier een 16 lang hex string van, bv X'a4c7ea38eb321205'
    --  * De SUBSTRING pakt daaruit het aantal HEX chars dat nodig is (altijd vanaf het einde terug)
    --  * Eerste POWER() kolom, vaste bit waarden volgens UUID version 4 specs
    --  * Tweede POWER() kolom, het aantal random bits in dat onderdeel.
    --
    -- xxxxxxxx-xxxx-AAAA-BBBB-xxxxxxxxxxxx
    -- 
    -- AAAA = 0100 0000 0000 0000 = Eerste 4 bits hard gekodeerd met de eerste POWER(),laatste 12 bits random met 2e POWER()
    -- BBBB = 1000 0000 0000 0000 = Eerste 2 bits hard gekodeerd met de eerste POWER(),laatste 14 bits random met 2e POWER()

    RETURN SUBSTRING(CAST(CAST(CAST(                 RAND() * POWER(2,32)   AS INT) AS BLOB) AS CHAR) FROM 11 FOR  8) || '-'
        || SUBSTRING(CAST(CAST(CAST(                 RAND() * POWER(2,16)   AS INT) AS BLOB) AS CHAR) FROM 15 FOR  4) || '-'
        || SUBSTRING(CAST(CAST(CAST( POWER(2,14) + ( RAND() * POWER(2,12) ) AS INT) AS BLOB) AS CHAR) FROM 15 FOR  4) || '-'
        || SUBSTRING(CAST(CAST(CAST( POWER(2,15) + ( RAND() * POWER(2,14) ) AS INT) AS BLOB) AS CHAR) FROM 15 FOR  4) || '-'
        || SUBSTRING(CAST(CAST(CAST(                 RAND() * POWER(2,48)   AS INT) AS BLOB) AS CHAR) FROM  7 FOR 12);

  END;

  CREATE FUNCTION UUID4ASCHAR_C () RETURNS CHAR

  BEGIN

    --  UUID Version 4
    --  ---------------
    --
    --  * Een 128 bit lange UUID Version 4 samenstellen in BIT type
    --  * Er een hex string van 32 lang van maken.
    --  * Streepjes toevoegen

    DECLARE uuid BIT RIGHT (CAST(CAST(RAND()*POWER(2,48) AS INT) AS BIT), 48)
                  || B'0100'
                  || RIGHT (CAST(CAST(RAND()*POWER(2,12) AS INT) AS BIT), 12)
                  || B'10'
                  || RIGHT (CAST(CAST(RAND()*POWER(2,30) AS INT) AS BIT), 30)
                  || RIGHT (CAST(CAST(RAND()*POWER(2,32) AS INT) AS BIT), 32);
    
    DECLARE hex CHAR SUBSTRING(CAST(CAST(uuid AS BLOB) AS CHAR) FROM 3 FOR 32);

    RETURN LEFT(hex,8)                  || '-'
        || SUBSTRING(hex FROM  9 FOR 4) || '-'
        || SUBSTRING(hex FROM 13 FOR 4) || '-'
        || SUBSTRING(hex FROM 17 FOR 4) || '-'
        || RIGHT(hex, 12);

    --  Bijzonderheid
    --  -------------
    --
    --  De laatste 2 random bit strings van 30 & 32 lang van het DECLARE uuid statement
    --  samenvoegen tot 1 van 62 werkte niet, de laatste bits waren dan altijd 0
    --
    --  RIGHT (CAST(CAST(RAND()*POWER(2,62) AS INT) AS BIT), 62)
    --
    --  RAND() geeft een FLOAT waarde retour tussen 0 en 1 (1 niet inclusief)
    --
    --  FLOAT is: 1 bit voor sign, 11 bits voor exponent, 52 bits voor fraction
    --            Die 52 is dan te weining ))) 
    --  
    --  RAND() * POWER(2,n) zal bij een n > 52 het resultaat niet goed verdeeld hebben,
    --  er zullen gaten zitten in de mogelijke waarden.
    --

  END;  
 
END MODULE;